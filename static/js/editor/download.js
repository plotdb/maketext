// Generated by LiveScript 1.3.0
window.convert = {
  prepare: function(){
    return new Promise(function(res, rej){
      var svg, svgWidth, textBox, feImages, style, node, this$ = this;
      svg = document.querySelector('#cooltext svg').cloneNode(true);
      svgWidth = document.querySelector('#cooltext').getBoundingClientRect().width;
      textBox = document.querySelector('#cooltext text').getBoundingClientRect();
      svg.setAttribute('width', svgWidth + "px");
      svg.setAttribute('height', '170px');
      feImages = Array.from(svg.querySelectorAll('feImage')).map(function(d, i){
        var href, ret;
        href = d.getAttributeNS('http://www.w3.org/1999/xlink', 'href') || d.getAttribute('href');
        ret = /^(data:image\/svg\+xml[^,]*?),([^]+)$/gm.exec(href);
        if (ret && !/base64/.exec(ret[1])) {
          href = ret[1] + ";base64," + btoa(ret[2]);
          return d.setAttributeNS('http://www.w3.org/1999/xlink', 'href', href);
        }
      });
      style = document.createElement("style");
      style.textContent = "text {\n  font-size: 64px;\n  font-family: Arial Black;\n  dominant-baseline: central;\n  text-anchor: middle;\n}";
      svg.appendChild(style);
      node = document.querySelector('#svg-work-area');
      if (!node) {
        node = document.createElement("div");
        node.setAttribute('id', 'svg-work-area');
        document.body.appendChild(node);
      }
      node.appendChild(svg);
      return textToSvg.load("/assets/fonts/ttf/" + (window.fontname || 'ArialBlack') + "-Regular.ttf", function(e, tts){
        return Array.from(svg.querySelectorAll('text')).map(function(text, i){
          var textbox, fontSize, textValue, d, g1, g2, path, parent, i$, ref$, len$, name, that, pbox, box, x, y;
          textbox = text.getBBox();
          fontSize = getComputedStyle(text).fontSize;
          fontSize = +(/(\d+)/.exec(fontSize) || [0, 64])[1];
          textValue = text.textContent || 'Hello World';
          d = tts.getD(textValue, {
            fontSize: fontSize
          });
          g1 = document.createElementNS("http://www.w3.org/2000/svg", "g");
          g2 = document.createElementNS("http://www.w3.org/2000/svg", "g");
          path = document.createElementNS("http://www.w3.org/2000/svg", "path");
          parent = text.parentNode;
          path.setAttribute('d', d);
          for (i$ = 0, len$ = (ref$ = ['fill', 'stroke', 'stroke-width']).length; i$ < len$; ++i$) {
            name = ref$[i$];
            if (that = text.getAttribute(name)) {
              path.setAttribute(name, that);
            }
          }
          parent.insertBefore(g1, text);
          g1.appendChild(g2);
          g2.appendChild(path);
          if (that = text.getAttribute('filter')) {
            g1.setAttribute('filter', that);
          }
          parent.removeChild(text);
          pbox = path.getBBox();
          box = {
            width: textBox.width * 1.2 + 20,
            height: textBox.height * 1.2 + 20
          };
          x = -path.getBBox().width * 0.5 - path.getBBox().x + textbox.width * 0.5 + textbox.x;
          y = path.getBBox().height * 0.5 + textbox.height * 0.5 + textbox.y;
          g2.setAttribute("transform", "translate(" + x + ", " + y + ")");
          svg.setAttribute('viewBox', "0 0 500 150");
          svg.setAttribute('width', box.width + "px");
          svg.setAttribute('height', box.height + "px");
          return res({
            svg: svg,
            text: textValue,
            width: box.width,
            height: box.height
          });
        });
      });
    });
  },
  download: function(option){
    var that, blob, url, x$, ref$;
    option == null && (option = {});
    $('#download').modal('show');
    if (that = option.blob) {
      blob = that;
    } else if (option.content) {
      blob = new Blob([option.content], {
        type: option.type
      });
    } else {
      null;
    }
    url = URL.createObjectURL(blob);
    document.querySelector('#download img').setAttribute('src', url);
    document.querySelector('#download .result').style.height = option.height + "px";
    x$ = document.querySelector('#download .btn');
    x$.setAttribute('href', url);
    x$.setAttribute('download', (option.name || 'output') + "." + (option.postfix || 'png'));
    return maketext.editor.fire('image.ready', (ref$ = {
      url: url
    }, ref$.name = option.name, ref$.type = option.type, ref$));
  },
  svg: function(){
    var this$ = this;
    return this.prepare().then(function(arg$){
      var svg, text, width, height;
      svg = arg$.svg, text = arg$.text, width = arg$.width, height = arg$.height;
      return this$.download({
        width: width,
        height: height,
        content: svg.outerHTML,
        type: 'image/svg+xml',
        name: text,
        postfix: 'svg'
      });
    });
  },
  png: function(){
    var ref$, textValue, box, this$ = this;
    ref$ = [
      '', {
        width: 500,
        height: 150
      }
    ], textValue = ref$[0], box = ref$[1];
    return this.prepare().then(function(arg$){
      var svg, text, width, height;
      svg = arg$.svg, text = arg$.text, width = arg$.width, height = arg$.height;
      textValue = text;
      box.width = width;
      box.height = height;
      return smiltool.svgToDataurl(svg.outerHTML);
    }).then(function(it){
      return smiltool.urlToDataurl(it, box.width, box.height);
    }).then(function(it){
      return smiltool.dataurlToBlob(it);
    }).then(function(it){
      return this$.download({
        width: box.width,
        height: box.height,
        blob: it,
        name: textValue,
        postfix: 'png',
        type: 'image/png'
      });
    });
  }
};